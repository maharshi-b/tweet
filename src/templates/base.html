{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Tweetme.co {% block title %} {% endblock title %}</title>

    <!-- Bootstrap -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> -->
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        .red-color {
            color: red;
        }

        .gray-color {
            color: gray;
        }
    </style>
</head>

<body>
    {% include "navbar.html" %}
    <div class="container">
        {% block content %}
        {% endblock content %}
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        function loadTweetContainer(tweetcontainerID) {
            var query = getParameterByName('q')
            var tweetList = []
            var nextPageUrl;

            var tweetContainer;
            if (tweetcontainerID) {
                tweetContainer = $("#" + tweetcontainerID)
            }
            else {
                tweetContainer = $("#tweet-container")
            }
            var initialUrl = tweetContainer.attr('data-url') || "/api/tweets/";

            $(document.body).on("click", ".retweet-btn", function (event) {
                event.preventDefault()
                console.log("CLICKED RETWEET BUTTOn")
                var url = "/api" + $(this).attr("href")
                $.ajax({
                    method: "GET",
                    url: url,
                    success: function (data) {
                    },
                    error: function (data) {
                        console.log("ERROR")
                        console.log(data)
                    }
                })
            })

            function updateHashLinks() {

                $(".media-heading").each(function (data) {
                    console.log('here')
                    var hashtagRegex = /(^|\s)#([\w\d-]+)/g
                    var usernameRegex = /(^|\s)@([\w\d-]+)/g
                    var currentHtml = $(this).html()
                    var newText;
                    newText = currentHtml.replace(hashtagRegex, "$1<a href='/tags/$2'>#$2</a>")
                    newText = newText.replace(usernameRegex, "$1<a href='/profiles/$2'>@$2</a>")
                    $(this).html(newText)
                })
            }
            function parseTweets() {
                if (tweetList == 0) {
                    tweetContainer.append("<h3>Empty</h3>");
                } else {
                    //Tweets Exist 
                    $.each(tweetList, function (key, value) {
                        var tweetContent = value.content;
                        var tweetUser = value.user;
                        var dateDisplay = value.date_display;
                        var timeSince = value.timesince;
                        var tweetkey = value.key;
                        var tweetFormattedHtml;
                        if (value.parent) {
                            var mainTweet = value.parent
                            tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\"><span class='gray-color'>"
                                + tweetUser.username + " Retweeted</span><br><h5 class=\"media-heading\">"
                                + mainTweet.content + "</h5>by <a href='" + mainTweet.user.url + "'>" + mainTweet.user.username
                                + "</a> | " + mainTweet.timesince + " | <a href='/tweets/" + mainTweet.id + "'>View</a>"
                                + " | <a class='retweet-btn' href='/tweets/" + mainTweet.id + "/retweet'>Retweet</a>"
                                + "</div></div><hr>"

                        }
                        else {
                            tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\"><h5 class=\"media-heading\">"
                                + tweetContent + "</h5>by <a href='" + tweetUser.url + "'>" + tweetUser.username
                                + "</a> | " + timeSince + " | <a href='/tweets/" + value.id + "'>View</a>"
                                + " | <a class='retweet-btn' href='/tweets/" + value.id + "/retweet'>Retweet</a>"
                                + "</div></div><hr>"
                        }
                        tweetContainer.append(tweetFormattedHtml)
                    });
                }
            }

            console.log(query)
            function fetchTweets(url) {
                var fetchUrl;
                if (!url) {
                    fetchUrl = initialUrl
                }
                else {
                    fetchUrl = url
                }
                $.ajax({
                    url: fetchUrl,
                    data: {
                        "q": query
                    },
                    method: "GET",
                    success: function (data) {
                        tweetList = data.results;
                        nextPageUrl = data.next;
                        parseTweets();
                        updateHashLinks();
                        if (nextPageUrl) {
                            $("#loadmore").css("display", "inline")
                        } else {
                            $("#loadmore").css("display", "none")
                        }
                    },
                    error: function (data) {
                        console.log('Error');
                        console.log(data);
                    }
                });
            }
            fetchTweets();
            $("#loadmore").click(function (event) {
                event.preventDefault()
                if (nextPageUrl) {
                    fetchTweets(nextPageUrl)
                }

            })
            var charsStart = 140;
            var charsCurrent = 0;
            $("#tweet-form").append("<span id='tweetCharsLeft'>" + charsStart + "</span>")
            $("#tweet-form textarea").keydown(function (event) {

                var tweetValue = $(this).val()
                charsCurrent = charsStart - tweetValue.length
                var spanChars = $("#tweetCharsLeft")
                spanChars.text(charsCurrent)
                if (charsCurrent >= 0) {
                    spanChars.removeClass("red-color")
                } else {
                    spanChars.addClass("red-color")
                }
            })
            $("#tweet-form").submit(function (event) {
                event.preventDefault()
                var charsStart = 140;
                var this_ = $(this)
                var formData = this_.serialize()
                if (charsCurrent >= 0) {
                    $.ajax({
                        url: "/api/tweets/create/",
                        data: formData,
                        method: "POST",
                        success: function (data) {
                            this_.find("input[type=text], textarea").val("")
                            console.log('Tweeted Successfully')
                            tweetContainer.empty();
                            $("#tweetCharsLeft").text(charsStart)
                            fetchTweets()
                        },
                        error: function (data) {
                            console.log('Error');
                            console.log(data.status);
                        }
                    });
                } else {
                    console.log("CANT SEND TOO MANY CHARS")
                }
            });

        }
    </script>
    {% block script %}{% endblock %}
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script> -->
</body>

</html>