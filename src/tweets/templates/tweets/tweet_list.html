{% extends 'base.html' %}





{% block script %}
<script>
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
    $(document).ready(function () {
        var query = getParameterByName('q')
        var tweetList = []
        var nextPageUrl;
        $(document.body).on("click", ".retweet-btn", function (event) {
            event.preventDefault()
            console.log("CLICKED RETWEET BUTTOn")
            var url = "/api" + $(this).attr("href")
            $.ajax({
                method: "GET",
                url: url,
                success: function (data) {
                    console.log(data)
                    fetchTweets()
                },
                error: function (data) {
                    console.log("ERROR")
                    console.log(data)
                }
            })
        })

        function updateHashLinks() {

            $(".media-heading").each(function (data) {
                console.log('here')
                var hashtagRegex = /(^|\s)#([\w\d-]+)/g
                var usernameRegex = /(^|\s)@([\w\d-]+)/g
                var currentHtml = $(this).html()
                var newText;
                newText = currentHtml.replace(hashtagRegex, "$1<a href='/tags/$2'>#$2</a>")
                newText = newText.replace(usernameRegex, "$1<a href='/profiles/$2'>@$2</a>")
                $(this).html(newText)
            })
        }
        function parseTweets() {
            if (tweetList == 0) {
                $("#tweet-container").append("<h3>Empty</h3>");
            } else {
                //Tweets Exist 
                $.each(tweetList, function (key, value) {
                    var tweetContent = value.content;
                    var tweetUser = value.user;
                    var dateDisplay = value.date_display;
                    var timeSince = value.timesince;
                    var tweetkey = value.key;
                    var tweetFormattedHtml;
                    if (value.parent) {
                        var mainTweet = value.parent
                        tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\"><span class='gray-color'>"
                            + tweetUser.username + " Retweeted</span><br><h5 class=\"media-heading\">"
                            + mainTweet.content + "</h5>by <a href='" + mainTweet.user.url + "'>" + mainTweet.user.username
                            + "</a> | " + mainTweet.timesince + " | <a href='/tweets/" + mainTweet.id + "'>View</a>"
                            + " | <a class='retweet-btn' href='/tweets/" + mainTweet.id + "/retweet'>Retweet</a>"
                            + "</div></div><hr>"

                    }
                    else {
                        tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\"><h5 class=\"media-heading\">"
                            + tweetContent + "</h5>by <a href='" + tweetUser.url + "'>" + tweetUser.username
                            + "</a> | " + timeSince + " | <a href='/tweets/" + value.id + "'>View</a>"
                            + " | <a class='retweet-btn' href='/tweets/" + value.id + "/retweet'>Retweet</a>"
                            + "</div></div><hr>"
                    }
                    $("#tweet-container").append(tweetFormattedHtml)
                });
            }
        }

        console.log(query)
        function fetchTweets(url) {
            var fetchUrl;
            if (!url) {
                fetchUrl = "/api/tweets/"
            }
            else {
                fetchUrl = url
            }
            $.ajax({
                url: fetchUrl,
                data: {
                    "q": query
                },
                method: "GET",
                success: function (data) {
                    tweetList = data.results;
                    nextPageUrl = data.next;
                    parseTweets();
                    updateHashLinks();
                    if (nextPageUrl) {
                        $("#loadmore").css("display", "inline")
                    } else {
                        $("#loadmore").css("display", "none")
                    }
                },
                error: function (data) {
                    console.log('Error');
                    console.log(data);
                }
            });
        }
        fetchTweets();
        $("#loadmore").click(function (event) {
            event.preventDefault()
            if (nextPageUrl) {
                fetchTweets(nextPageUrl)
            }

        })
        var charsStart = 140;
        var charsCurrent = 0;
        $("#tweet-form").append("<span id='tweetCharsLeft'>" + charsStart + "</span>")
        $("#tweet-form textarea").keydown(function (event) {

            var tweetValue = $(this).val()
            charsCurrent = charsStart - tweetValue.length
            var spanChars = $("#tweetCharsLeft")
            spanChars.text(charsCurrent)
            if (charsCurrent >= 0) {
                spanChars.removeClass("red-color")
            } else {
                spanChars.addClass("red-color")
            }
        })
        $("#tweet-form").submit(function (event) {
            event.preventDefault()
            var charsStart = 140;
            var this_ = $(this)
            var formData = this_.serialize()
            if (charsCurrent >= 0) {
                $.ajax({
                    url: "/api/tweets/create/",
                    data: formData,
                    method: "POST",
                    success: function (data) {
                        this_.find("input[type=text], textarea").val("")
                        console.log('Tweeted Successfully')
                        $("#tweet-container").empty();
                        $("#tweetCharsLeft").text(charsStart)
                        fetchTweets()
                    },
                    error: function (data) {
                        console.log('Error');
                        console.log(data.status);
                    }
                });
            } else {
                console.log("CANT SEND TOO MANY CHARS")
            }
        });
    });
</script>
{% endblock %}



{% block content %}

<div class="row">
    <div class="col-sm-3 col-xs-12" style="background-color: red;">
        <h1>{{request.user}}</h1>
    </div>
    <div class="col-sm-9 col-xs-12">
        {% if not request.GET.q %}
        <div>
            {% include "tweets/form.html" with form=create_form action_url=create_url btn_title='Tweet' id='tweet-form' %}
        </div>
        <hr>
        {% endif %}
        <div id="tweet-container">
        </div>
        <a href="#" id='loadmore'>Load More</a>
    </div>
</div>

{% endblock content %}