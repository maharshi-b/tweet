{% extends 'base.html' %}





{% block script %}
<script>
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
    $(document).ready(function () {
        var query = getParameterByName('q')
        var tweetList = []
        function parseTweets() {
            $("#tweet-container").empty();
            if (tweetList == 0) {
                $("#tweet-container").append("<h3>Empty</h3>");
            } else {
                //Tweets Exist 
                $.each(tweetList, function (key, value) {
                    var tweetContent = value.content;
                    var tweetUser = value.user;
                    var dateDisplay = value.date_display;
                    var timeSince = value.timesince;
                    var tweetkey = value.key;
                    $("#tweet-container").append(
                        "<div class=\"media\"><div class=\"media - body\"> <h5 class=\"media - heading\">"
                        + tweetContent + "</h5>by " + tweetUser.username
                        + " | " + timeSince + " | <a href=\"#\">View</a></div></div><hr>"
                    )
                });
            }
        }

        console.log(query)
        function fetchTweets() {
            $.ajax({
                url: "/api/tweets/",
                data: {
                    "q": query
                },
                method: "GET",
                success: function (data) {
                    tweetList = data;
                    parseTweets();
                },
                error: function (data) {
                    console.log('Error');
                    console.log(data);
                }
            });
        }
        fetchTweets();
        $("#tweet-form").submit(function (event) {
            event.preventDefault()
            var this_ = $(this)
            var formData = this_.serialize()
            $.ajax({
                url: "/api/tweets/create/",
                data: formData,
                method: "POST",
                success: function (data) {
                    this_.find("input[type=text], textarea").val("")
                    console.log('Tweeted Successfully')
                    fetchTweets()
                },
                error: function (data) {
                    console.log('Error');
                    console.log(data.status);
                }
            });
        });
    });
</script>
{% endblock %}



{% block content %}

<div class="row">
    <div class="col-sm-3 col-xs-12" style="background-color: red;">
        <h1>{{request.user}}</h1>
    </div>
    <div class="col-sm-9 col-xs-12">
        {% if not request.GET.q %}
        <div>
            {% include "tweets/form.html" with form=create_form action_url=create_url btn_title='Tweet' id='tweet-form' %}
        </div>
        <hr>
        {% endif %}
        <div id="tweet-container">
        </div>
    </div>
</div>

{% endblock content %}